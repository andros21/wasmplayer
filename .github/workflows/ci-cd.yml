---
name: ci/cd

"on":
  workflow_dispatch:
  push:
    branches:
      - master
    paths-ignore:
      - LICENSE
      - README.md
      - fly.toml
      - '.github/workflows/*'
      - '.github/dependabot.yaml'
      - '.github/CODEOWNERS'
  pull_request:
    branches:
      - master
    paths-ignore:
      - LICENSE
      - README.md
      - fly.toml
      - '.github/workflows/*'
      - '.github/dependabot.yaml'
      - '.github/CODEOWNERS'

jobs:
  build:
    name: build wasmplayer
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: checkout project
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: rust stable latest
        id: rust
        run: |
          latest="$(curl -sL https://api.github.com/repos/rust-lang/rust/releases/latest | jq -r .tag_name)"
          echo "rust stable latest: ${latest}"
          echo "stable_latest=${latest}" >> "$GITHUB_OUTPUT"
          used="$(cargo --version | awk '{print $2}')"
          echo "rust stable used: ${used}"
          echo "stable_used=${used}" >> "$GITHUB_OUTPUT"
      - name: check cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        id: cache
        with:
          path: |
            ~/.cargo/
            ~/.rustup/
            target/
          key: ${{ runner.os }}-rust-${{ steps.rust.outputs.stable_latest }}-${{ hashFiles('Cargo.toml') }}-${{ hashFiles('Cargo.lock') }}
      - name: update toolchain
        if: steps.rust.outputs.stable_latest != steps.rust.outputs.stable_used
        run: |
          rustup update stable
      - name: cargo fmt
        run: |
          cargo fmt -- --check --verbose
      - name: cargo clippy
        run: |
          cargo clippy --locked --workspace
      - name: install wasm-pack
        uses: taiki-e/install-action@e43a5023a747770bfcb71ae048541a681714b951
        with:
          tool: wasm-pack
          checksum: true
      - name: build wasmplayer
        run: |
          wasm-pack build --release --target web --no-opt
      - name: upload wasmplayer
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        with:
          name: wasmplayer
          path: pkg/
          if-no-files-found: error
          retention-days: 1
  deploy:
    name: deploy wasmplayer
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: checkout project
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: download wasmplayer
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: wasmplayer
          path: pkg/
      - name: prepare wasmplayer
        run: |
          set -x
          mkdir -p wasmplayer/pkg/
          mv pkg/wasmplayer.js \
             pkg/wasmplayer_bg.wasm \
             wasmplayer/pkg/
          mv assets/ \
             index.html \
             wasmplayer/
      - name: publish to gh-pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: wasmplayer/
